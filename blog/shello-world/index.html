<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
        <link rel="stylesheet" href="/site.css">
    </head>

    <body>
        <h1>Windows x86 and x64 null-free position-independent shellcode</h1>

        <p>These are hello world shellcodes that lay some foundation for building upon. They navigate the TEB and PEB in order to get kernel32.dll, find two functions (<span>GetStdHandle</span>, <span>WriteFile</span>) using a weak hash of their name, then call those functions to print a message. There are some techniques used to keep them null free.</p>

        <div>
            <h2>Null-free PIC</h2>

            <p>Shellcode is often passed through string processing functions, so having nulls in the assembled code will result in having only part of your code copied in. Similarly, it is running at some arbitrary address in memory, so it cannot reference things relative to where it is. So it must also be position independent.</p>

            <p>To get rid of nulls we use some common tricks that make our assembly a little less natural. To move a low value into a register, we don't want to move <span>0x41</span> into a 64-bit register because the instruction will encode the number as <span>0x0000000000000041</span>. Instead, we xor the register with itself to zero out the high bits, then use a smaller addressable piece of the register to move the value in, for example, <span>mov al, 041h</span></p>

            <p>To be position independent, we want to grab the instruction pointer at a known location in our code and find things relative to that. To get <span>EIP</span> (32-bit) or <span>RIP</span> (64-bit), we will do a <span>call</span> then pop the address of the next instruction (the return address) off the stack. One issue is that calls to nearby instructions that are going forward in the code will have zeros in the opcodes since they are relative. We can, however, <span>jmp</span> then <span>call</span> backward to avoid nulls.</p>

            <p>The one other trick we see is with <span>mov eax, 41414141h + offset get_message_ret - offset msglen</span> followed by <span>sub eax, 41414141h</span>. Offset is like an assembler macro that will calculate the offsets of labels. So that is getting the relative distance between the return address we get off the stack and the declared message length.</p>

            <p>Since this value is fairly small but the offsets are treated as 32-bit values, we add a an arbitrary constant (0x41414141) then subtract that constant to avoid nulls in the instruction.</p>
        </div>

        <div>
            <h2>Me and the Boys (PEB & TEB)</h2>

            <p>Syscall numbers on Windows are not a stable ABI. For this reason, we are going to walk the loaded modules, then walk those modules' functions to find what we need. The thread environment block (TEB) has some thread-relevant information and is stored in the <span>fs</span> <a href="https://en.wikipedia.org/wiki/Win32_Thread_Information_Block">segment register</a> on 32-bit and in <span>gs</span> on 64-bit. The TEB has a pointer to the process environment block (PEB) which is what we are really after.</p>

            <p>Once we have ol' PEB, we need to get the <a href="https://github.com/winsiderss/systeminformer/blob/2c9dd8765011a85fd98774cb37ff4ef52923d8c1/phnt/include/ntpebteb.h#L107"><span>ldr</span> member</a>, which is a linked list of loaded modules (DLLs). You can see the linked list structure as well as the data struct <a href="https://learn.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb_ldr_data">here</a>.</p>

            <p>You could do a similar hashy thing as we do in the next section to find the module you need based on the name, but the first three are always going to be the <span>main program</span>, <span>ntdll</span>, then <span>kernel32</span>, so we just do three dereferences. Then we grab the offset in the <span>kernel32</span> struct that gives us the loaded module's base address.</p>

            <pre>
<div style="white-space:pre;-moz-tab-size:4;tab-size:4;"><span style="color:#ec5f66;">get_exports:</span><br>    <span style="color:#5fb4b4;">ASSUME</span> <span style="color:#ec5f66;">FS:</span>NOTHING<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">eax</span>, <span style="color:#5fb4b4;">eax</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, <span style="color:#ec5f66;">fs:</span>[<span style="color:#5fb4b4;">eax</span>+<span style="color:#f9ae58;">30h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">PEB</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, [<span style="color:#5fb4b4;">eax</span>+<span style="color:#f9ae58;">0Ch</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">LDR</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">ecx</span>, [<span style="color:#5fb4b4;">eax</span>+<span style="color:#f9ae58;">14h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">program</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">ecx</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">ntdll</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">ecx</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">eax</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">kernel32</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, [<span style="color:#5fb4b4;">ecx</span>+<span style="color:#f9ae58;">10h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">base </span><span style="color:#a6acb9;">address</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-04h</span><span style="font-style:italic;">]</span>, <span style="color:#5fb4b4;">eax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">[</span><span style="color:#a6acb9;">ebp-04h]</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">ecx</span>, <span style="color:#5fb4b4;">ecx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">ecx</span>, [<span style="color:#5fb4b4;">eax</span>+<span style="color:#f9ae58;">3Ch</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">ntheader </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">ecx</span>, [<span style="color:#5fb4b4;">eax</span>+<span style="color:#5fb4b4;">ecx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">ntheader</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">edi</span>, <span style="color:#5fb4b4;">edi</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">di</span>, <span style="color:#f9ae58;">04179h</span> <br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">di</span>, <span style="color:#f9ae58;">04101h</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#5fb4b4;">edx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edx</span>, [<span style="color:#5fb4b4;">ecx</span>+<span style="color:#5fb4b4;">edi</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">export </span><span style="color:#a6acb9;">directory </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">edi</span>, [<span style="color:#5fb4b4;">eax</span>+<span style="color:#5fb4b4;">edx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">export </span><span style="color:#a6acb9;">directory</span></div>
            </pre>

            <p>With <span>kernel32</span>'s base address, our next step will be to traverse its export table to find the functions we want.</p>
        </div>

        <div>
            <h2>Exports by Hash</h2>

            <p>So let's pretend we were cool malware and we didn't want to have the strings of the functions we are importing in memory for the loser anti-virus programs to alert on. In this case we would create some weak hash of the function name, then loop over the module's export table, hash each name and compare it to our target hashes.</p>

            <p>For this hash we can just do a little bit-wise xor'ing and rotation. It would be smart to make sure there are no collisions but it works when we run it so we're probably good. We prototype the hash algorithm in Python to make it easy to hash function names.</p>

            <pre>
<div style="white-space:pre;-moz-tab-size:4;tab-size:4;"><span style="color:#c695c6;font-style:italic;">def</span> <span style="color:#5fb4b4;">rol32</span><span style="color:#ffffff;">(</span><span style="color:#f9ae58;">x</span><span style="color:#a6acb9;">,</span> <span style="color:#f9ae58;">n</span><span style="color:#ffffff;">)</span><span style="color:#ffffff;">:</span><br>    <span style="color:#c695c6;">return</span> <span style="color:#ffffff;">(</span><span style="color:#ffffff;">(</span>x <span style="color:#f97b58;">&lt;&lt;</span> n<span style="color:#ffffff;">)</span> <span style="color:#f97b58;">&amp;</span> <span style="color:#f9ae58;">0x</span><span style="color:#f9ae58;">FFFFFFFF</span><span style="color:#ffffff;">)</span> <span style="color:#f97b58;">|</span> <span style="color:#ffffff;">(</span>x <span style="color:#f97b58;">>></span> <span style="color:#ffffff;">(</span><span style="color:#f9ae58;">32</span> <span style="color:#f97b58;">-</span> n<span style="color:#ffffff;">)</span><span style="color:#ffffff;">)</span><br><br><span style="color:#c695c6;font-style:italic;">def</span> <span style="color:#5fb4b4;">hash</span><span style="color:#ffffff;">(</span><span style="color:#f9ae58;">bs</span><span style="color:#ffffff;">)</span><span style="color:#ffffff;">:</span><br>    edx <span style="color:#f97b58;">=</span> <span style="color:#f9ae58;">0</span><br>    <span style="color:#c695c6;">for</span> ea <span style="color:#c695c6;">in</span> bs<span style="color:#ffffff;">:</span><br>        edx <span style="color:#f97b58;">=</span> <span style="color:#6699cc;">rol32</span><span style="color:#ffffff;">(</span>edx<span style="color:#a6acb9;">,</span> <span style="color:#f9ae58;">5</span><span style="color:#ffffff;">)</span><br>        edx <span style="color:#f97b58;">^=</span> ea<br>    <span style="color:#c695c6;">return</span> edx</div>
            </pre>

            <p>After that, we just drop our target hashes in the program and hope we implemented the same algorithm in ASM!</p>

            <pre>
<div style="white-space:pre;-moz-tab-size:4;tab-size:4;"><span style="color:#ec5f66;">loop_chars:</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">hash</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">rol </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#f9ae58;">5</span> <br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">dl</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">esi</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">chr</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">inc </span><span style="color:#5fb4b4;">esi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">next </span><span style="color:#a6acb9;">chr</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">cmp </span><span style="color:#5fb4b4;">al</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">esi</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">cmp </span><span style="color:#a6acb9;">null</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jne </span>loop_chars <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">keep </span><span style="color:#a6acb9;">hashing</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edi</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-18h</span><span style="font-style:italic;">]</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">cmp </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#5fb4b4;">edi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">cmp </span><span style="color:#a6acb9;">GetStdHandle </span><span style="color:#a6acb9;">hash</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">je </span>found_stdout<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edi</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-14h</span><span style="font-style:italic;">]</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">cmp </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#5fb4b4;">edi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">cmp </span><span style="color:#a6acb9;">WriteFile </span><span style="color:#a6acb9;">hash</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">je </span>found_writef<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jmp </span>check_name <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">next </span><span style="color:#a6acb9;">function</span></div>
            </pre>
        </div>

        <div>
            <h2>Shellcode Extraction</h2>

            <p>Unfortunately, assemblers aren't set up to just spit out shellcode. We will assemble our code, then extract it from the COFF object that gets created.</p>

            <p>For this, we open up the appropriate Visual Studio Developer Command Prompt. Use the normal one for 64-bit and the x86 one for 32-bit. Our assembler is called <span>ml.exe</span> and should be on the PATH in this command prompt.</p>

            <p>That outputs a COFF object file, so we will use <span>dumpbin /disasm</span> to get the disassembly (and hex opcodes), ripgrep (<span>rg</span>) to grab the hex opcodes, then a Python snippet to write those to a file. This is probably not a very complex format and we should just write a proper parser, but this works for now.</p>

            <pre>
<div style="white-space:pre;-moz-tab-size:4;tab-size:4;"><span style="color:#f97b58;">@</span><span style="color:#6699cc;font-style:italic;">echo</span> <span style="color:#ec5f66;font-style:italic;">off</span><br><span style="color:#6699cc;font-style:italic;">set</span> PYSCRIPT<span style="color:#f97b58;">=</span><span style="color:#99c794;">import</span><span style="color:#99c794;"> </span><span style="color:#99c794;">sys</span><span style="color:#99c794;">; </span><span style="color:#99c794;">import</span><span style="color:#99c794;"> </span><span style="color:#99c794;">pathlib</span><span style="color:#99c794;">; </span><span style="color:#a6acb9;">^</span><br><span style="color:#99c794;">pathlib.Path('hello.bin').write_bytes</span><span style="color:#99c794;">(</span><span style="color:#99c794;">bytes.fromhex(</span><span style="color:#a6acb9;">^</span><br><span style="color:#99c794;">''.join</span><span style="color:#99c794;">(</span><span style="color:#99c794;">sys.stdin.read().split())))</span><br><br><span style="color:#6699cc;">ml</span> <span style="color:#5fb4b4;">/</span><span style="color:#f9ae58;">c</span> <span style="color:#99c794;">hello.asm</span><br><span style="color:#6699cc;">dumpbin</span> <span style="color:#5fb4b4;">/</span><span style="color:#f9ae58;">DISASM</span><span style="color:#f97b58;">:</span><span style="color:#99c794;">wide</span> <span style="color:#99c794;">hello.obj</span> <span style="color:#a6acb9;">^</span><br>   <span style="color:#f97b58;">|</span> <span style="color:#6699cc;">rg</span> <span style="color:#5fb4b4;">-</span><span style="color:#f9ae58;">o</span> <span style="color:#5fb4b4;">-</span><span style="color:#f9ae58;">P</span> <span style="color:#5fb4b4;">-</span><span style="color:#f9ae58;">e</span> <span style="color:#99c794;">"</span><span style="color:#99c794;">(?&lt;=[0-9A-Fa-f]{8}: </span><span style="color:#99c794;">)([0-9A-Fa-f]{2} </span><span style="color:#99c794;">?)+</span><span style="color:#99c794;">"</span> <span style="color:#a6acb9;">^</span><br>   <span style="color:#f97b58;">|</span> <span style="color:#6699cc;">python</span> <span style="color:#5fb4b4;">-</span><span style="color:#f9ae58;">c</span> <span style="color:#99c794;">"</span><span style="color:#ffffff;">%</span>PYSCRIPT<span style="color:#ffffff;">%</span><span style="color:#99c794;">"</span></div>
            </pre>

            <p><i>Note: For 64-bit you will have to change the regex to have a 16 instead of an 8 for the address lookbehind. Also change the file name to match whatever your file is called.</i></p>

        <div>
            <h2>32-bit Hello World</h2>

            <p>The 64-bit version was the first iteration and it, for the most part, keeps everything in registers. The 32-bit version (this one), due to a more limited register selection, was forced to put more stuff on the stack and feels a bit cleaner.</p>

            <pre>
<div style="white-space:pre;-moz-tab-size:4;tab-size:4;">prologue <span style="color:#5fb4b4;">MACRO</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">ebp</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">ebx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">edi</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">esi</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">ebp</span>, <span style="color:#5fb4b4;">esp</span><br><span style="color:#5fb4b4;">ENDM</span><br><br>epilogue <span style="color:#5fb4b4;">MACRO</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">esp</span>, <span style="color:#5fb4b4;">ebp</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">esi</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">edi</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">ebx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">ebp</span><br><span style="color:#5fb4b4;">ENDM</span><br><br><span style="color:#5fb4b4;">.MODEL</span> <span style="color:#c695c6;">flat</span>, <span style="color:#c695c6;">stdcall</span><br><span style="color:#5fb4b4;">.CODE</span><br><br><span style="color:#ec5f66;">start:</span><br>    prologue<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">esp</span>, <span style="color:#f9ae58;">20h</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">[</span><span style="color:#a6acb9;">ebp-04h] </span><span style="color:#a6acb9;">module_base</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">[</span><span style="color:#a6acb9;">ebp-08h] </span><span style="color:#a6acb9;">function_addresses</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">[</span><span style="color:#a6acb9;">ebp-0Ch] </span><span style="color:#a6acb9;">ordinals</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">[</span><span style="color:#a6acb9;">ebp-10h] </span><span style="color:#a6acb9;">name_rvas</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">[</span><span style="color:#a6acb9;">ebp-14h] </span><span style="color:#a6acb9;">hash_write_file</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">[</span><span style="color:#a6acb9;">ebp-18h] </span><span style="color:#a6acb9;">hash_get_std_handle</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">[</span><span style="color:#a6acb9;">ebp-1Ch] </span><span style="color:#a6acb9;">idx_write_file</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">[</span><span style="color:#a6acb9;">ebp-20h] </span><span style="color:#a6acb9;">idx_get_std_handle</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jmp </span>get_exports<br><span style="color:#ec5f66;">based:</span><br>    message <span style="color:#5fb4b4;">db</span> <span style="color:#99c794;">'</span><span style="color:#99c794;">Shello </span><span style="color:#99c794;">World! </span><span style="color:#99c794;">(</span><span style="color:#99c794;">x86)'</span>, <span style="color:#f9ae58;">0Ah</span>, <span style="color:#f9ae58;">0Ah</span><br>    msglen <span style="color:#5fb4b4;">db</span> $-message<br>    author <span style="color:#5fb4b4;">db</span> <span style="color:#99c794;">'</span><span style="color:#99c794;">TACIXAT'</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">nop</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">nop</span><br><span style="color:#ec5f66;">get_exports:</span><br>    <span style="color:#5fb4b4;">ASSUME</span> <span style="color:#ec5f66;">FS:</span>NOTHING<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">eax</span>, <span style="color:#5fb4b4;">eax</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, <span style="color:#ec5f66;">fs:</span>[<span style="color:#5fb4b4;">eax</span>+<span style="color:#f9ae58;">30h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">PEB</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, [<span style="color:#5fb4b4;">eax</span>+<span style="color:#f9ae58;">0Ch</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">LDR</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">ecx</span>, [<span style="color:#5fb4b4;">eax</span>+<span style="color:#f9ae58;">14h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">program</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">ecx</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">ntdll</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">ecx</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">eax</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">kernel32</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, [<span style="color:#5fb4b4;">ecx</span>+<span style="color:#f9ae58;">10h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">base </span><span style="color:#a6acb9;">address</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-04h</span><span style="font-style:italic;">]</span>, <span style="color:#5fb4b4;">eax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">[</span><span style="color:#a6acb9;">ebp-04h]</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">ecx</span>, <span style="color:#5fb4b4;">ecx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">ecx</span>, [<span style="color:#5fb4b4;">eax</span>+<span style="color:#f9ae58;">3Ch</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">ntheader </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">ecx</span>, [<span style="color:#5fb4b4;">eax</span>+<span style="color:#5fb4b4;">ecx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">ntheader</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">edi</span>, <span style="color:#5fb4b4;">edi</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">di</span>, <span style="color:#f9ae58;">04179h</span> <br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">di</span>, <span style="color:#f9ae58;">04101h</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#5fb4b4;">edx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edx</span>, [<span style="color:#5fb4b4;">ecx</span>+<span style="color:#5fb4b4;">edi</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">export </span><span style="color:#a6acb9;">directory </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">edi</span>, [<span style="color:#5fb4b4;">eax</span>+<span style="color:#5fb4b4;">edx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">export </span><span style="color:#a6acb9;">directory</span><br><span style="color:#ec5f66;">search:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#5fb4b4;">edx</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">these </span><span style="color:#a6acb9;">offsets </span><span style="color:#a6acb9;">are </span><span style="color:#a6acb9;">wrong</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edx</span>, [<span style="color:#5fb4b4;">edi</span>+<span style="color:#f9ae58;">1Ch</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">function </span><span style="color:#a6acb9;">addresses </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">edx</span>, [<span style="color:#5fb4b4;">eax</span>+<span style="color:#5fb4b4;">edx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">function </span><span style="color:#a6acb9;">addresses </span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-08h</span><span style="font-style:italic;">]</span>, <span style="color:#5fb4b4;">edx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">[</span><span style="color:#a6acb9;">ebp-08h]</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#5fb4b4;">edx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edx</span>, [<span style="color:#5fb4b4;">edi</span>+<span style="color:#f9ae58;">24h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">ordinals </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">edx</span>, [<span style="color:#5fb4b4;">eax</span>+<span style="color:#5fb4b4;">edx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">ordinals</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-0Ch</span><span style="font-style:italic;">]</span>, <span style="color:#5fb4b4;">edx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">[</span><span style="color:#a6acb9;">ebp-0Ch]</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#5fb4b4;">edx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edx</span>, [<span style="color:#5fb4b4;">edi</span>+<span style="color:#f9ae58;">20h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">name </span><span style="color:#a6acb9;">rvas </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">ecx</span>, [<span style="color:#5fb4b4;">eax</span>+<span style="color:#5fb4b4;">edx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">name </span><span style="color:#a6acb9;">RVAs</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-10h</span><span style="font-style:italic;">]</span>, <span style="color:#5fb4b4;">ecx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">[</span><span style="color:#a6acb9;">ebp-10h]</span><br><span style="color:#ec5f66;">find_func:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, <span style="color:#f9ae58;">0AE72FD6Fh</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-14h</span><span style="font-style:italic;">]</span>, <span style="color:#5fb4b4;">eax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">hash </span><span style="color:#a6acb9;">WriteFile</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, <span style="color:#f9ae58;">0B43C4D5Ch</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-18h</span><span style="font-style:italic;">]</span>, <span style="color:#5fb4b4;">eax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">hash </span><span style="color:#a6acb9;">GetStdHandle</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">eax</span>, <span style="color:#5fb4b4;">eax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">scratch</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">esi</span>, <span style="color:#5fb4b4;">esi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">name </span><span style="color:#a6acb9;">pointer</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">ecx</span>, <span style="color:#5fb4b4;">ecx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">counter</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">dec </span><span style="color:#5fb4b4;">ecx</span><br><span style="color:#ec5f66;">check_name:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">inc </span><span style="color:#5fb4b4;">ecx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#5fb4b4;">edx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">hash</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-04h</span><span style="font-style:italic;">]</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">esi</span>, <span style="color:#5fb4b4;">eax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">module </span><span style="color:#a6acb9;">base</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edi</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-10h</span><span style="font-style:italic;">]</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, [<span style="color:#5fb4b4;">edi</span>+<span style="color:#5fb4b4;">ecx</span>*<span style="color:#f9ae58;">4</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">rva</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">add </span><span style="color:#5fb4b4;">esi</span>, <span style="color:#5fb4b4;">eax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">name</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">eax</span>, <span style="color:#5fb4b4;">eax</span><br><span style="color:#ec5f66;">loop_chars:</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">hash</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">rol </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#f9ae58;">5</span> <br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">dl</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">esi</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">chr</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">inc </span><span style="color:#5fb4b4;">esi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">next </span><span style="color:#a6acb9;">chr</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">cmp </span><span style="color:#5fb4b4;">al</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">esi</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">cmp </span><span style="color:#a6acb9;">null</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jne </span>loop_chars <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">keep </span><span style="color:#a6acb9;">hashing</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edi</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-18h</span><span style="font-style:italic;">]</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">cmp </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#5fb4b4;">edi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">cmp </span><span style="color:#a6acb9;">GetStdHandle </span><span style="color:#a6acb9;">hash</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">je </span>found_stdout<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edi</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-14h</span><span style="font-style:italic;">]</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">cmp </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#5fb4b4;">edi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">cmp </span><span style="color:#a6acb9;">WriteFile </span><span style="color:#a6acb9;">hash</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">je </span>found_writef<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jmp </span>check_name <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">next </span><span style="color:#a6acb9;">function</span><br><span style="color:#ec5f66;">found_stdout:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-20h</span><span style="font-style:italic;">]</span>, <span style="color:#5fb4b4;">ecx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">save </span><span style="color:#a6acb9;">GetStdHandle </span><span style="color:#a6acb9;">idx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jmp </span>check_name <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">next </span><span style="color:#a6acb9;">function</span><br><span style="color:#ec5f66;">found_writef:</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">WriteFile </span><span style="color:#a6acb9;">index </span><span style="color:#a6acb9;">in </span><span style="color:#a6acb9;">ecx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-1Ch</span><span style="font-style:italic;">]</span>, <span style="color:#5fb4b4;">ecx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">store </span><span style="color:#a6acb9;">WriteFile </span><span style="color:#a6acb9;">index</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">ecx</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-0Ch</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">ords</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">esi</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-20h</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">GetStdHandle </span><span style="color:#a6acb9;">index</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">si</span>, [<span style="color:#5fb4b4;">ecx</span>+<span style="color:#5fb4b4;">esi</span>*<span style="color:#f9ae58;">2</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">GetStdHandle </span><span style="color:#a6acb9;">ord</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">ecx</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-08h</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">RVAs</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">esi</span>, [<span style="color:#5fb4b4;">ecx</span>+<span style="color:#5fb4b4;">esi</span>*<span style="color:#f9ae58;">4</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">GetStdHandle </span><span style="color:#a6acb9;">RVA</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-04h</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">base </span><span style="color:#a6acb9;">address</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">add </span><span style="color:#5fb4b4;">esi</span>, <span style="color:#5fb4b4;">eax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">GetStdHandle </span><span style="color:#a6acb9;">pointer</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">ecx</span>, <span style="color:#5fb4b4;">ecx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">eax</span>, <span style="color:#5fb4b4;">eax</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">al</span>, <span style="color:#f9ae58;">0Bh</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">ecx</span>, <span style="color:#5fb4b4;">eax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">stdout </span><span style="color:#a6acb9;">is </span><span style="color:#a6acb9;">-11</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">ecx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">GetStdHandle </span><span style="color:#a6acb9;">arg0</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">call </span><span style="color:#5fb4b4;">esi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">call </span><span style="color:#a6acb9;">GetStdHandle</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">stdout </span><span style="color:#a6acb9;">in </span><span style="color:#a6acb9;">eax</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">eax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">arg0 </span><span style="color:#a6acb9;">WriteFile</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jmp </span>j_get_message<br><span style="color:#ec5f66;">get_message:</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">get_rip </span><span style="color:#a6acb9;">addr </span><span style="color:#a6acb9;">on </span><span style="color:#a6acb9;">stack</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">esi</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">eax</span>, <span style="color:#5fb4b4;">eax</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, <span style="color:#f9ae58;">41414141h</span> + offset get_message_ret - offset msglen<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">eax</span>, <span style="color:#f9ae58;">41414141h</span> <br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">esi</span>, <span style="color:#5fb4b4;">eax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">msglen</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">ecx</span>, <span style="color:#5fb4b4;">ecx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">cl</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">esi</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">ecx </span><span style="color:#a6acb9;">holds </span><span style="color:#a6acb9;">msglen</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">esi</span>, <span style="color:#5fb4b4;">ecx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">esi </span><span style="color:#a6acb9;">holds </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">message</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">eax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">arg0 </span><span style="color:#a6acb9;">WriteFile</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#5fb4b4;">edx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">edx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">arg4 </span><span style="color:#a6acb9;">WriteFile</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">edx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">arg3 </span><span style="color:#a6acb9;">WriteFile</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">ecx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">arg2 </span><span style="color:#a6acb9;">WriteFile</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">esi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">arg1 </span><span style="color:#a6acb9;">WriteFile</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">eax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">arg0 </span><span style="color:#a6acb9;">WriteFile</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jmp </span>get_message_ret<br><span style="color:#ec5f66;">j_get_message:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">call </span>get_message<br><span style="color:#ec5f66;">get_message_ret:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">ecx</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-0Ch</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">ords</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">esi</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-1Ch</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">WriteFile </span><span style="color:#a6acb9;">index</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">edi</span>, <span style="color:#5fb4b4;">edi</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">di</span>, [<span style="color:#5fb4b4;">ecx</span>+<span style="color:#5fb4b4;">esi</span>*<span style="color:#f9ae58;">2</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">WriteFile </span><span style="color:#a6acb9;">ord</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">ecx</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-08h</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">RVAs</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">esi</span>, [<span style="color:#5fb4b4;">ecx</span>+<span style="color:#5fb4b4;">edi</span>*<span style="color:#f9ae58;">4</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">WriteFile </span><span style="color:#a6acb9;">RVA</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">ebp-04h</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">base </span><span style="color:#a6acb9;">address</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">add </span><span style="color:#5fb4b4;">esi</span>, <span style="color:#5fb4b4;">eax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">WriteFile </span><span style="color:#a6acb9;">pointer</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">call </span><span style="color:#5fb4b4;">esi</span><br>    epilogue<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">ret</span><br><span style="color:#5fb4b4;">db</span> <span style="color:#f9ae58;">0DEh</span>, <span style="color:#f9ae58;">0ADh</span>, <span style="color:#f9ae58;">0BEh</span>, <span style="color:#f9ae58;">0EFh</span><br><span style="color:#5fb4b4;">end</span></div>
            </pre>
        </div>

        <div>
            <h2>64-bit Hello World</h2>

            <p>The macros in here are because the <a href="https://en.wikipedia.org/wiki/X86_calling_conventions#Microsoft_x64_calling_convention">64-bit calling convention</a> is wild. The first 4 arguments go in registers, anything more goes on the stack. You need to preserve any volatile registers you want to save, handle stack alignment, and then slap on 32 bytes of shadow space before making the call. After the call you have to undo all that.</p> 

            <p>For the alignment part, the stack needs to be aligned to 16 bytes <i>after</i> any arguments are pushed onto the stack. So an even number of arguments (or fewer than 4) will mean you align the stack before setting up args, an odd number (greater than 4) will mean you unalign it so it is aligned once the arguments are pushed. Rather than tracking how many pushes and pops we have done in our shellcode up to that point, we just have some macros to align or unalign the stack.</p>

            <pre>
<div style="white-space:pre;font-family:Consolas;-moz-tab-size:4;tab-size:4;"><span style="color:#a6acb9;">;;;;;;;;;;;;</span><br><span style="color:#a6acb9;">;  </span><span style="color:#a6acb9;">MACROS  </span><span style="color:#a6acb9;">;</span><br><span style="color:#a6acb9;">;;;;;;;;;;;;</span><br><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">align </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">16 </span><span style="color:#a6acb9;">bytes</span><br>stack_align <span style="color:#5fb4b4;">MACRO</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rbx</span>, <span style="color:#5fb4b4;">rsp</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">and </span><span style="color:#5fb4b4;">rbx</span>, <span style="color:#f9ae58;">0Fh</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">rsp</span>, <span style="color:#5fb4b4;">rbx</span><br><span style="color:#5fb4b4;">ENDM</span><br><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">unalign </span><span style="color:#a6acb9;">from </span><span style="color:#a6acb9;">16 </span><span style="color:#a6acb9;">bytes</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">used </span><span style="color:#a6acb9;">for </span><span style="color:#a6acb9;">calls </span><span style="color:#a6acb9;">with </span><span style="color:#a6acb9;">odd </span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">number </span><span style="color:#a6acb9;">of </span><span style="color:#a6acb9;">arguments </span><span style="color:#a6acb9;">gt </span><span style="color:#a6acb9;">4</span><br>stack_unalign <span style="color:#5fb4b4;">MACRO</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rbx</span>, <span style="color:#5fb4b4;">rsp</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">add </span><span style="color:#5fb4b4;">bl</span>, <span style="color:#f9ae58;">8</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">and </span><span style="color:#5fb4b4;">rbx</span>, <span style="color:#f9ae58;">0Fh</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">rsp</span>, <span style="color:#5fb4b4;">rbx</span><br><span style="color:#5fb4b4;">ENDM</span><br><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">undo </span><span style="color:#a6acb9;">whatever </span><span style="color:#a6acb9;">align/ </span><span style="color:#a6acb9;">unalign</span><br>reset_align <span style="color:#5fb4b4;">MACRO</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">add </span><span style="color:#5fb4b4;">rsp</span>, <span style="color:#5fb4b4;">rbx</span><br><span style="color:#5fb4b4;">ENDM</span><br><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">create </span><span style="color:#a6acb9;">shadow </span><span style="color:#a6acb9;">space</span><br>sub_shadow <span style="color:#5fb4b4;">MACRO</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">rsp</span>, <span style="color:#f9ae58;">20h</span><br><span style="color:#5fb4b4;">ENDM</span><br><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">clear </span><span style="color:#a6acb9;">shadow </span><span style="color:#a6acb9;">space</span><br>add_shadow <span style="color:#5fb4b4;">MACRO</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">add </span><span style="color:#5fb4b4;">rsp</span>, <span style="color:#f9ae58;">20h</span><br><span style="color:#5fb4b4;">ENDM</span><br><br>scall <span style="color:#5fb4b4;">MACRO</span> fn<br>    sub_shadow<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">call </span>fn<br>    add_shadow<br><span style="color:#5fb4b4;">ENDM</span><br><br>prologue <span style="color:#5fb4b4;">MACRO</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">rbp</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rbp</span>, <span style="color:#5fb4b4;">rsp</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">rbx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">rdi</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">rsi</span><br><span style="color:#5fb4b4;">ENDM</span><br><br>epilogue <span style="color:#5fb4b4;">MACRO</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">rsi</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">rdi</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">rbx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rsp</span>, <span style="color:#5fb4b4;">rbp</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">rbp</span><br><span style="color:#5fb4b4;">ENDM</span><br><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">preserve</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">RBX, </span><span style="color:#a6acb9;">RBP, </span><span style="color:#a6acb9;">RDI, </span><span style="color:#a6acb9;">RSI, </span><span style="color:#a6acb9;">RSP, </span><span style="color:#a6acb9;">R12, </span><span style="color:#a6acb9;">R13, </span><span style="color:#a6acb9;">R14, </span><span style="color:#a6acb9;">R15</span><br><br><span style="color:#a6acb9;">; args in </span><span style="color:#a6acb9;">RCX, </span><span style="color:#a6acb9;">RDX, </span><span style="color:#a6acb9;">R8, </span><span style="color:#a6acb9;">R9</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">un</span><span style="color:#a6acb9;">/</span><span style="color:#a6acb9;">align</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">stack </span><span style="color:#a6acb9;">args</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">shadow</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">call</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">unshadow</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">un </span><span style="color:#a6acb9;">args</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">reset </span><span style="color:#a6acb9;">align</span><br><br><span style="color:#5fb4b4;">.CODE</span><br><br><span style="color:#ec5f66;">start:</span><br>    prologue<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jmp </span>get_exports<br><span style="color:#ec5f66;">based:</span><br>    message <span style="color:#5fb4b4;">db</span> <span style="color:#99c794;">'</span><span style="color:#99c794;">Shello </span><span style="color:#99c794;">World!'</span>, <span style="color:#f9ae58;">0Ah</span>, <span style="color:#f9ae58;">0Ah</span><br>    msglen <span style="color:#5fb4b4;">db</span> $-message<br>    author <span style="color:#5fb4b4;">db</span> <span style="color:#99c794;">'</span><span style="color:#99c794;">TACIXAT'</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">nop</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">nop</span><br><span style="color:#ec5f66;">get_exports:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rax</span>, <span style="color:#5fb4b4;">rax</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rax</span>, <span style="color:#ec5f66;">gs:</span>[<span style="color:#5fb4b4;">rax</span>+<span style="color:#f9ae58;">60h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">PEB</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rax</span>, [<span style="color:#5fb4b4;">rax</span>+<span style="color:#f9ae58;">18h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">LDR</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rcx</span>, [<span style="color:#5fb4b4;">rax</span>+<span style="color:#f9ae58;">20h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">program</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rax</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">rcx</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">ntdll</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rcx</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">rax</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">kernel32</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rax</span>, [<span style="color:#5fb4b4;">rcx</span>+<span style="color:#f9ae58;">20h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">base </span><span style="color:#a6acb9;">address</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rcx</span>, <span style="color:#5fb4b4;">rcx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">ecx</span>, [<span style="color:#5fb4b4;">rax</span>+<span style="color:#f9ae58;">3Ch</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">ntheader </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">rcx</span>, [<span style="color:#5fb4b4;">rax</span>+<span style="color:#5fb4b4;">rcx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">ntheader</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">r8</span>, <span style="color:#5fb4b4;">r8</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span>r8b, <span style="color:#f9ae58;">088h</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rdx</span>, <span style="color:#5fb4b4;">rdx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edx</span>, [<span style="color:#5fb4b4;">rcx</span>+<span style="color:#5fb4b4;">r8</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">export </span><span style="color:#a6acb9;">directory </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">rdi</span>, [<span style="color:#5fb4b4;">rax</span>+<span style="color:#5fb4b4;">rdx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">export </span><span style="color:#a6acb9;">directory</span><br><span style="color:#ec5f66;">search:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rdx</span>, <span style="color:#5fb4b4;">rdx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edx</span>, [<span style="color:#5fb4b4;">rdi</span>+<span style="color:#f9ae58;">1Ch</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">function </span><span style="color:#a6acb9;">addresses </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">rdx</span>, [<span style="color:#5fb4b4;">rax</span>+<span style="color:#5fb4b4;">rdx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">function </span><span style="color:#a6acb9;">addresses</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">rdx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rdx</span>, <span style="color:#5fb4b4;">rdx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edx</span>, [<span style="color:#5fb4b4;">rdi</span>+<span style="color:#f9ae58;">24h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">ordinals </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">rdx</span>, [<span style="color:#5fb4b4;">rax</span>+<span style="color:#5fb4b4;">rdx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">ordinals</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">rdx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rdx</span>, <span style="color:#5fb4b4;">rdx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edx</span>, [<span style="color:#5fb4b4;">rdi</span>+<span style="color:#f9ae58;">20h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">name </span><span style="color:#a6acb9;">rvas </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">rcx</span>, [<span style="color:#5fb4b4;">rax</span>+<span style="color:#5fb4b4;">rdx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">name </span><span style="color:#a6acb9;">RVAs</span><br><span style="color:#ec5f66;">find_func:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">r9</span>, <span style="color:#5fb4b4;">r9</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">scratch</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">r10</span>, <span style="color:#5fb4b4;">r10</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">name </span><span style="color:#a6acb9;">pointer</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">r8</span>, <span style="color:#5fb4b4;">r8</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">counter</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">dec </span><span style="color:#5fb4b4;">r8</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rdi</span>, <span style="color:#5fb4b4;">rdi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">target</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edi</span>, <span style="color:#f9ae58;">0AE72FD6Fh</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">WriteFile</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rsi</span>, <span style="color:#5fb4b4;">rsi</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">esi</span>, <span style="color:#f9ae58;">0B43C4D5Ch</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">GetStdHandle</span><br><span style="color:#ec5f66;">check_name:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">inc </span><span style="color:#5fb4b4;">r8</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rdx</span>, <span style="color:#5fb4b4;">rdx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">hash</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">r10</span>, <span style="color:#5fb4b4;">rax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">module </span><span style="color:#a6acb9;">base</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">r9d</span>, [<span style="color:#5fb4b4;">rcx</span>+<span style="color:#5fb4b4;">r8</span>*<span style="color:#f9ae58;">4</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">rva</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">add </span><span style="color:#5fb4b4;">r10</span>, <span style="color:#5fb4b4;">r9</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">name</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">r9</span>, <span style="color:#5fb4b4;">r9</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">zero</span><br><span style="color:#ec5f66;">loop_chars:</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">hash</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">rol </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#f9ae58;">5</span> <br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">dl</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">r10</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">chr</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">inc </span><span style="color:#5fb4b4;">r10</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">next </span><span style="color:#a6acb9;">chr</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">cmp </span>r9b, <span style="font-style:italic;">[</span><span style="font-style:italic;">r10</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">cmp </span><span style="color:#a6acb9;">null</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jne </span>loop_chars <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">keep </span><span style="color:#a6acb9;">hashing</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">cmp </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#5fb4b4;">esi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">cmp </span><span style="color:#a6acb9;">getstdhandle </span><span style="color:#a6acb9;">hash</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">je </span>found_stdout<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">cmp </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#5fb4b4;">edi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">cmp </span><span style="color:#a6acb9;">write </span><span style="color:#a6acb9;">file </span><span style="color:#a6acb9;">hash</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">je </span>found_writef<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jmp </span>check_name <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">next </span><span style="color:#a6acb9;">function</span><br><span style="color:#ec5f66;">found_stdout:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">r8</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">save </span><span style="color:#a6acb9;">getstdhandle </span><span style="color:#a6acb9;">idx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jmp </span>check_name <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">next </span><span style="color:#a6acb9;">function</span><br><span style="color:#ec5f66;">found_writef:</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">writefile </span><span style="color:#a6acb9;">index </span><span style="color:#a6acb9;">in </span><span style="color:#a6acb9;">r8</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">r9</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">getstdhandle </span><span style="color:#a6acb9;">in </span><span style="color:#a6acb9;">r9</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">rcx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">ordinals</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">r8w</span>, [<span style="color:#5fb4b4;">rcx</span>+<span style="color:#5fb4b4;">r8</span>*<span style="color:#f9ae58;">2</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">writefile </span><span style="color:#a6acb9;">ord</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">r9w</span>, [<span style="color:#5fb4b4;">rcx</span>+<span style="color:#5fb4b4;">r9</span>*<span style="color:#f9ae58;">2</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">getstdhandle </span><span style="color:#a6acb9;">ord</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">rcx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">RVAs</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">r8d</span>, [<span style="color:#5fb4b4;">rcx</span>+<span style="color:#5fb4b4;">r8</span>*<span style="color:#f9ae58;">4</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">writefile </span><span style="color:#a6acb9;">rva</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">r9d</span>, [<span style="color:#5fb4b4;">rcx</span>+<span style="color:#5fb4b4;">r9</span>*<span style="color:#f9ae58;">4</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">getstdhandle </span><span style="color:#a6acb9;">rva</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">add </span><span style="color:#5fb4b4;">r8</span>, <span style="color:#5fb4b4;">rax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">writefile </span><span style="color:#a6acb9;">pointer</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">r8</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">save </span><span style="color:#a6acb9;">writefile</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">add </span><span style="color:#5fb4b4;">r9</span>, <span style="color:#5fb4b4;">rax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">getstdhandle </span><span style="color:#a6acb9;">pointer</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rcx</span>, <span style="color:#5fb4b4;">rcx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">r11</span>, <span style="color:#5fb4b4;">r11</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span>r11b, <span style="color:#f9ae58;">0Bh</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">ecx</span>, <span style="color:#5fb4b4;">r11d</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">stdout </span><span style="color:#a6acb9;">is </span><span style="color:#a6acb9;">-11 </span><span style="color:#a6acb9;">as </span><span style="color:#a6acb9;">a </span><span style="color:#a6acb9;">UINT32</span><br>    stack_align<br>    scall <span style="color:#5fb4b4;">r9</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">call </span><span style="color:#a6acb9;">getstdhandle</span><br>    reset_align<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">rax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">save </span><span style="color:#a6acb9;">stdhandle</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jmp </span>j_get_message<br><span style="color:#ec5f66;">get_message:</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">get_rip </span><span style="color:#a6acb9;">addr </span><span style="color:#a6acb9;">on </span><span style="color:#a6acb9;">stack</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">r8</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rax</span>, <span style="color:#5fb4b4;">rax</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, <span style="color:#f9ae58;">41414141h</span> + offset get_message_ret - offset msglen<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">eax</span>, <span style="color:#f9ae58;">41414141h</span> <br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">r8</span>, <span style="color:#5fb4b4;">rax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">msglen</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rdx</span>, <span style="color:#5fb4b4;">r8</span> <br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">r8</span>, <span style="color:#5fb4b4;">r8</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span>r8b, <span style="font-style:italic;">[</span><span style="font-style:italic;">rdx</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">msglen</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">rdx</span>, <span style="color:#5fb4b4;">r8</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">message</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jmp </span>get_message_ret<br><span style="color:#ec5f66;">j_get_message:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">call </span>get_message<br><span style="color:#ec5f66;">get_message_ret:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">rcx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">stdhandle</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">rsi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">writefile </span><span style="color:#a6acb9;">pointer</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">r9</span>, <span style="color:#5fb4b4;">r9</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">out </span><span style="color:#a6acb9;">NULL</span><br>    stack_unalign<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">r9</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">reserved </span><span style="color:#a6acb9;">NULL</span><br>    scall <span style="color:#5fb4b4;">rsi</span><br>    reset_align<br>    epilogue<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">ret</span><br><span style="color:#5fb4b4;">db</span> <span style="color:#f9ae58;">0DEh</span>, <span style="color:#f9ae58;">0ADh</span>, <span style="color:#f9ae58;">0BEh</span>, <span style="color:#f9ae58;">0EFh</span><br><span style="color:#5fb4b4;">end</span></div>
            </pre>
        </div>

    </body>
</html>

