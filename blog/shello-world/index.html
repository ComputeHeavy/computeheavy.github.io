<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
        <link rel="stylesheet" href="/site.css">
    </head>

    <body>
        <h1>Windows x86 and x64 null-free position-independent shellcode</h1>

        <p>These are hello world shellcodes that lay some foundation for building upon. They navigate the TEB and PEB in order to get kernel32.dll, find two functions (<span>GetStdHandle</span>, <span>WriteFile</span>) using a weak hash of their name, then call those functions to print a message. There are some techniques used to keep them null free.</p>

        <div>
            <h2>Null-free PIC</h2>

            <p>Shellcode is often passed through string processing functions, so having nulls in the assembled code will result in having only part of your code copied in. Similarly, it is running at some arbitrary address in memory, so it cannot reference things relative to where it is. So it must also be position independent.</p>

            <p>To get rid of nulls we use some common tricks that make our assembly a little less natural. To move a low value into a register, we don't want to move <span>0x41</span> into a 64 bit register because the instruction will encode the number as <span>0x0000000000000041</span>. Instead, we xor the register with itself to zero out the high bits, then use a smaller addressable piece of the register to move the value in, for example, <span>mov al, 041h</span></p>

            <p>To be position independent, we want to grab the instruction pointer at a known location in our code and find things relative to that. To get <span>EIP</span> (32 bit) or <span>RIP</span> (64 bit), we will do a <span>call</span> then pop the address of the next instruction (the return address) off the stack. One issue is that calls to nearby instructions that are going forward in the code will have zeros in the opcodes since they are relative. We can, however, <span>jmp</span> then <span>call</span> backward to avoid nulls.</p>
        </div>

        <pre>
<div style="white-space:pre;font-family:Consolas;-moz-tab-size:4;tab-size:4;"><span style="color:#a6acb9;">;;;;;;;;;;;;</span><br><span style="color:#a6acb9;">;  </span><span style="color:#a6acb9;">MACROS  </span><span style="color:#a6acb9;">;</span><br><span style="color:#a6acb9;">;;;;;;;;;;;;</span><br><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">align </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">16 </span><span style="color:#a6acb9;">bytes</span><br>stack_align <span style="color:#5fb4b4;">MACRO</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rbx</span>, <span style="color:#5fb4b4;">rsp</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">and </span><span style="color:#5fb4b4;">rbx</span>, <span style="color:#f9ae58;">0Fh</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">rsp</span>, <span style="color:#5fb4b4;">rbx</span><br><span style="color:#5fb4b4;">ENDM</span><br><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">unalign </span><span style="color:#a6acb9;">from </span><span style="color:#a6acb9;">16 </span><span style="color:#a6acb9;">bytes</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">used </span><span style="color:#a6acb9;">for </span><span style="color:#a6acb9;">calls </span><span style="color:#a6acb9;">with </span><span style="color:#a6acb9;">odd </span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">number </span><span style="color:#a6acb9;">of </span><span style="color:#a6acb9;">arguments </span><span style="color:#a6acb9;">gt </span><span style="color:#a6acb9;">4</span><br>stack_unalign <span style="color:#5fb4b4;">MACRO</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rbx</span>, <span style="color:#5fb4b4;">rsp</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">add </span><span style="color:#5fb4b4;">bl</span>, <span style="color:#f9ae58;">8</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">and </span><span style="color:#5fb4b4;">rbx</span>, <span style="color:#f9ae58;">0Fh</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">rsp</span>, <span style="color:#5fb4b4;">rbx</span><br><span style="color:#5fb4b4;">ENDM</span><br><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">undo </span><span style="color:#a6acb9;">whatever </span><span style="color:#a6acb9;">align/ </span><span style="color:#a6acb9;">unalign</span><br>reset_align <span style="color:#5fb4b4;">MACRO</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">add </span><span style="color:#5fb4b4;">rsp</span>, <span style="color:#5fb4b4;">rbx</span><br><span style="color:#5fb4b4;">ENDM</span><br><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">create </span><span style="color:#a6acb9;">shadow </span><span style="color:#a6acb9;">space</span><br>sub_shadow <span style="color:#5fb4b4;">MACRO</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">rsp</span>, <span style="color:#f9ae58;">20h</span><br><span style="color:#5fb4b4;">ENDM</span><br><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">clear </span><span style="color:#a6acb9;">shadow </span><span style="color:#a6acb9;">space</span><br>add_shadow <span style="color:#5fb4b4;">MACRO</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">add </span><span style="color:#5fb4b4;">rsp</span>, <span style="color:#f9ae58;">20h</span><br><span style="color:#5fb4b4;">ENDM</span><br><br>scall <span style="color:#5fb4b4;">MACRO</span> fn<br>    sub_shadow<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">call </span>fn<br>    add_shadow<br><span style="color:#5fb4b4;">ENDM</span><br><br>prologue <span style="color:#5fb4b4;">MACRO</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">rbp</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rbp</span>, <span style="color:#5fb4b4;">rsp</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">rbx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">rdi</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">rsi</span><br><span style="color:#5fb4b4;">ENDM</span><br><br>epilogue <span style="color:#5fb4b4;">MACRO</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">rsi</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">rdi</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">rbx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rsp</span>, <span style="color:#5fb4b4;">rbp</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">rbp</span><br><span style="color:#5fb4b4;">ENDM</span><br><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">preserve</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">RBX, </span><span style="color:#a6acb9;">RBP, </span><span style="color:#a6acb9;">RDI, </span><span style="color:#a6acb9;">RSI, </span><span style="color:#a6acb9;">RSP, </span><span style="color:#a6acb9;">R12, </span><span style="color:#a6acb9;">R13, </span><span style="color:#a6acb9;">R14, </span><span style="color:#a6acb9;">R15</span><br><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">rcx, </span><span style="color:#a6acb9;">rdx, </span><span style="color:#a6acb9;">r8, </span><span style="color:#a6acb9;">r9</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">un</span><span style="color:#a6acb9;">/</span><span style="color:#a6acb9;">align</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">stack </span><span style="color:#a6acb9;">args</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">shadow</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">call</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">unshadow</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">un </span><span style="color:#a6acb9;">args</span><br><span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">reset </span><span style="color:#a6acb9;">align</span><br><br><span style="color:#5fb4b4;">.CODE</span><br><br><span style="color:#ec5f66;">start:</span><br>    prologue<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jmp </span>get_exports<br><span style="color:#ec5f66;">based:</span><br>    message <span style="color:#5fb4b4;">db</span> <span style="color:#99c794;">'</span><span style="color:#99c794;">Shello </span><span style="color:#99c794;">World!'</span>, <span style="color:#f9ae58;">0Ah</span>, <span style="color:#f9ae58;">0Ah</span><br>    msglen <span style="color:#5fb4b4;">db</span> $-message<br>    author <span style="color:#5fb4b4;">db</span> <span style="color:#99c794;">'</span><span style="color:#99c794;">TACIXAT'</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">nop</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">nop</span><br><span style="color:#ec5f66;">get_exports:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rax</span>, <span style="color:#5fb4b4;">rax</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rax</span>, <span style="color:#ec5f66;">gs:</span>[<span style="color:#5fb4b4;">rax</span>+<span style="color:#f9ae58;">60h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">PEB</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rax</span>, [<span style="color:#5fb4b4;">rax</span>+<span style="color:#f9ae58;">18h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">LDR</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rcx</span>, [<span style="color:#5fb4b4;">rax</span>+<span style="color:#f9ae58;">20h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">program</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rax</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">rcx</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">ntdll</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rcx</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">rax</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">kernel32</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rax</span>, [<span style="color:#5fb4b4;">rcx</span>+<span style="color:#f9ae58;">20h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">base </span><span style="color:#a6acb9;">address</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rcx</span>, <span style="color:#5fb4b4;">rcx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">ecx</span>, [<span style="color:#5fb4b4;">rax</span>+<span style="color:#f9ae58;">3Ch</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">ntheader </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">rcx</span>, [<span style="color:#5fb4b4;">rax</span>+<span style="color:#5fb4b4;">rcx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">ntheader</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">r8</span>, <span style="color:#5fb4b4;">r8</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span>r8b, <span style="color:#f9ae58;">088h</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rdx</span>, <span style="color:#5fb4b4;">rdx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edx</span>, [<span style="color:#5fb4b4;">rcx</span>+<span style="color:#5fb4b4;">r8</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">export </span><span style="color:#a6acb9;">directory </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">rdi</span>, [<span style="color:#5fb4b4;">rax</span>+<span style="color:#5fb4b4;">rdx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">export </span><span style="color:#a6acb9;">directory</span><br><span style="color:#ec5f66;">search:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rdx</span>, <span style="color:#5fb4b4;">rdx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edx</span>, [<span style="color:#5fb4b4;">rdi</span>+<span style="color:#f9ae58;">1Ch</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">function </span><span style="color:#a6acb9;">addresses </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">rdx</span>, [<span style="color:#5fb4b4;">rax</span>+<span style="color:#5fb4b4;">rdx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">function </span><span style="color:#a6acb9;">addresses</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">rdx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rdx</span>, <span style="color:#5fb4b4;">rdx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edx</span>, [<span style="color:#5fb4b4;">rdi</span>+<span style="color:#f9ae58;">24h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">ordinals </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">rdx</span>, [<span style="color:#5fb4b4;">rax</span>+<span style="color:#5fb4b4;">rdx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">ordinals</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">rdx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rdx</span>, <span style="color:#5fb4b4;">rdx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edx</span>, [<span style="color:#5fb4b4;">rdi</span>+<span style="color:#f9ae58;">20h</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">name </span><span style="color:#a6acb9;">rvas </span><span style="color:#a6acb9;">offset</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">lea </span><span style="color:#5fb4b4;">rcx</span>, [<span style="color:#5fb4b4;">rax</span>+<span style="color:#5fb4b4;">rdx</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">name </span><span style="color:#a6acb9;">RVAs</span><br><span style="color:#ec5f66;">find_func:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">r9</span>, <span style="color:#5fb4b4;">r9</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">scratch</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">r10</span>, <span style="color:#5fb4b4;">r10</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">name </span><span style="color:#a6acb9;">pointer</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">r8</span>, <span style="color:#5fb4b4;">r8</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">counter</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">dec </span><span style="color:#5fb4b4;">r8</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rdi</span>, <span style="color:#5fb4b4;">rdi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">target</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">edi</span>, <span style="color:#f9ae58;">0AE72FD6Fh</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">WriteFile</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rsi</span>, <span style="color:#5fb4b4;">rsi</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">esi</span>, <span style="color:#f9ae58;">0B43C4D5Ch</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">GetStdHandle</span><br><span style="color:#ec5f66;">check_name:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">inc </span><span style="color:#5fb4b4;">r8</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rdx</span>, <span style="color:#5fb4b4;">rdx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">hash</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">r10</span>, <span style="color:#5fb4b4;">rax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">module </span><span style="color:#a6acb9;">base</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">r9d</span>, [<span style="color:#5fb4b4;">rcx</span>+<span style="color:#5fb4b4;">r8</span>*<span style="color:#f9ae58;">4</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">rva</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">add </span><span style="color:#5fb4b4;">r10</span>, <span style="color:#5fb4b4;">r9</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">name</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">r9</span>, <span style="color:#5fb4b4;">r9</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">zero</span><br><span style="color:#ec5f66;">loop_chars:</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">hash</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">rol </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#f9ae58;">5</span> <br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">dl</span>, <span style="font-style:italic;">[</span><span style="font-style:italic;">r10</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">chr</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">inc </span><span style="color:#5fb4b4;">r10</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">next </span><span style="color:#a6acb9;">chr</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">cmp </span>r9b, <span style="font-style:italic;">[</span><span style="font-style:italic;">r10</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">cmp </span><span style="color:#a6acb9;">null</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jne </span>loop_chars <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">keep </span><span style="color:#a6acb9;">hashing</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">cmp </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#5fb4b4;">esi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">cmp </span><span style="color:#a6acb9;">getstdhandle </span><span style="color:#a6acb9;">hash</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">je </span>found_stdout<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">cmp </span><span style="color:#5fb4b4;">edx</span>, <span style="color:#5fb4b4;">edi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">cmp </span><span style="color:#a6acb9;">write </span><span style="color:#a6acb9;">file </span><span style="color:#a6acb9;">hash</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">je </span>found_writef<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jmp </span>check_name <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">next </span><span style="color:#a6acb9;">function</span><br><span style="color:#ec5f66;">found_stdout:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">r8</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">save </span><span style="color:#a6acb9;">getstdhandle </span><span style="color:#a6acb9;">idx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jmp </span>check_name <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">next </span><span style="color:#a6acb9;">function</span><br><span style="color:#ec5f66;">found_writef:</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">writefile </span><span style="color:#a6acb9;">index </span><span style="color:#a6acb9;">in </span><span style="color:#a6acb9;">r8</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">r9</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">getstdhandle </span><span style="color:#a6acb9;">in </span><span style="color:#a6acb9;">r9</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">rcx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">ordinals</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">r8w</span>, [<span style="color:#5fb4b4;">rcx</span>+<span style="color:#5fb4b4;">r8</span>*<span style="color:#f9ae58;">2</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">writefile </span><span style="color:#a6acb9;">ord</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">r9w</span>, [<span style="color:#5fb4b4;">rcx</span>+<span style="color:#5fb4b4;">r9</span>*<span style="color:#f9ae58;">2</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">getstdhandle </span><span style="color:#a6acb9;">ord</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">rcx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">RVAs</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">r8d</span>, [<span style="color:#5fb4b4;">rcx</span>+<span style="color:#5fb4b4;">r8</span>*<span style="color:#f9ae58;">4</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">writefile </span><span style="color:#a6acb9;">rva</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">r9d</span>, [<span style="color:#5fb4b4;">rcx</span>+<span style="color:#5fb4b4;">r9</span>*<span style="color:#f9ae58;">4</span>] <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">getstdhandle </span><span style="color:#a6acb9;">rva</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">add </span><span style="color:#5fb4b4;">r8</span>, <span style="color:#5fb4b4;">rax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">writefile </span><span style="color:#a6acb9;">pointer</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">r8</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">save </span><span style="color:#a6acb9;">writefile</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">add </span><span style="color:#5fb4b4;">r9</span>, <span style="color:#5fb4b4;">rax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">getstdhandle </span><span style="color:#a6acb9;">pointer</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rcx</span>, <span style="color:#5fb4b4;">rcx</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">r11</span>, <span style="color:#5fb4b4;">r11</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span>r11b, <span style="color:#f9ae58;">0Bh</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">ecx</span>, <span style="color:#5fb4b4;">r11d</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">stdout </span><span style="color:#a6acb9;">is </span><span style="color:#a6acb9;">-11 </span><span style="color:#a6acb9;">as </span><span style="color:#a6acb9;">a </span><span style="color:#a6acb9;">UINT32</span><br>    stack_align<br>    scall <span style="color:#5fb4b4;">r9</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">call </span><span style="color:#a6acb9;">getstdhandle</span><br>    reset_align<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">rax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">save </span><span style="color:#a6acb9;">stdhandle</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jmp </span>j_get_message<br><span style="color:#ec5f66;">get_message:</span><br>    <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">get_rip </span><span style="color:#a6acb9;">addr </span><span style="color:#a6acb9;">on </span><span style="color:#a6acb9;">stack</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">r8</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">rax</span>, <span style="color:#5fb4b4;">rax</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">eax</span>, <span style="color:#f9ae58;">41414141h</span> + offset get_message_ret - offset msglen<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">eax</span>, <span style="color:#f9ae58;">41414141h</span> <br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">r8</span>, <span style="color:#5fb4b4;">rax</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">msglen</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span><span style="color:#5fb4b4;">rdx</span>, <span style="color:#5fb4b4;">r8</span> <br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">r8</span>, <span style="color:#5fb4b4;">r8</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">mov </span>r8b, <span style="font-style:italic;">[</span><span style="font-style:italic;">rdx</span><span style="font-style:italic;">]</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">msglen</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">sub </span><span style="color:#5fb4b4;">rdx</span>, <span style="color:#5fb4b4;">r8</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">pointer </span><span style="color:#a6acb9;">to </span><span style="color:#a6acb9;">message</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">jmp </span>get_message_ret<br><span style="color:#ec5f66;">j_get_message:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">call </span>get_message<br><span style="color:#ec5f66;">get_message_ret:</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">rcx</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">stdhandle</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">pop </span><span style="color:#5fb4b4;">rsi</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">writefile </span><span style="color:#a6acb9;">pointer</span><br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">xor </span><span style="color:#5fb4b4;">r9</span>, <span style="color:#5fb4b4;">r9</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">out </span><span style="color:#a6acb9;">NULL</span><br>    stack_unalign<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">push </span><span style="color:#5fb4b4;">r9</span> <span style="color:#a6acb9;">; </span><span style="color:#a6acb9;">reserved </span><span style="color:#a6acb9;">NULL</span><br>    scall <span style="color:#5fb4b4;">rsi</span><br>    reset_align<br>    epilogue<br><span style="color:#6699cc;font-style:italic;">    </span><span style="color:#6699cc;font-style:italic;">ret</span><br><span style="color:#5fb4b4;">db</span> <span style="color:#f9ae58;">0DEh</span>, <span style="color:#f9ae58;">0ADh</span>, <span style="color:#f9ae58;">0BEh</span>, <span style="color:#f9ae58;">0EFh</span><br><span style="color:#5fb4b4;">end</span><br><br></div>
        </pre>

        <pre>
prologue MACRO
    push ebp
    push ebx
    push edi
    push esi
    mov ebp, esp
ENDM

epilogue MACRO
    mov esp, ebp
    pop esi
    pop edi
    pop ebx
    pop ebp
ENDM

.MODEL flat, stdcall
.CODE

start:
    prologue
    sub esp, 20h
    ; [ebp-04h] module_base
    ; [ebp-08h] function_addresses
    ; [ebp-0Ch] ordinals
    ; [ebp-10h] name_rvas
    ; [ebp-14h] hash_write_file
    ; [ebp-18h] hash_get_std_handle
    ; [ebp-1Ch] idx_write_file
    ; [ebp-20h] idx_get_std_handle
    jmp get_exports
based:
    message db 'Shello World! (x86)', 0Ah, 0Ah
    msglen db $-message
    author db 'TACIXAT'
    nop
    nop
get_exports:
    ASSUME FS:NOTHING
    xor eax, eax
    mov eax, fs:[eax+30h] ; PEB
    mov eax, [eax+0Ch] ; LDR
    mov ecx, [eax+14h] ; program
    mov eax, [ecx] ; ntdll
    mov ecx, [eax] ; kernel32
    mov eax, [ecx+10h] ; base address
    mov [ebp-04h], eax ; [ebp-04h]
    xor ecx, ecx
    mov ecx, [eax+3Ch] ; ntheader offset
    lea ecx, [eax+ecx] ; ntheader
    xor edi, edi
    mov di, 04179h 
    sub di, 04101h
    xor edx, edx
    mov edx, [ecx+edi] ; export directory offset
    lea edi, [eax+edx] ; export directory
search:
    xor edx, edx
    ; these offsets are wrong
    mov edx, [edi+1Ch] ; function addresses offset
    lea edx, [eax+edx] ; pointer to function addresses 
    mov [ebp-08h], edx ; [ebp-08h]
    xor edx, edx
    mov edx, [edi+24h] ; ordinals offset
    lea edx, [eax+edx] ; pointer to ordinals
    mov [ebp-0Ch], edx ; [ebp-0Ch]
    xor edx, edx
    mov edx, [edi+20h] ; name rvas offset
    lea ecx, [eax+edx] ; pointer to name RVAs
    mov [ebp-10h], ecx ; [ebp-10h]
find_func:
    mov eax, 0AE72FD6Fh
    mov [ebp-14h], eax ; hash WriteFile
    mov eax, 0B43C4D5Ch
    mov [ebp-18h], eax ; hash GetStdHandle
    xor eax, eax ; scratch
    xor esi, esi ; name pointer
    xor ecx, ecx ; counter
    dec ecx
check_name:
    inc ecx
    xor edx, edx ; hash
    mov eax, [ebp-04h]
    mov esi, eax ; module base
    mov edi, [ebp-10h]
    mov eax, [edi+ecx*4] ; rva
    add esi, eax ; name
    xor eax, eax
loop_chars:
    ; hash
    rol edx, 5 
    xor dl, [esi] ; chr
    inc esi ; next chr
    cmp al, [esi] ; cmp null
    jne loop_chars ; keep hashing
    mov edi, [ebp-18h]
    cmp edx, edi ; cmp GetStdHandle hash
    je found_stdout
    mov edi, [ebp-14h]
    cmp edx, edi ; cmp WriteFile hash
    je found_writef
    jmp check_name ; next function
found_stdout:
    mov [ebp-20h], ecx ; save GetStdHandle idx
    jmp check_name ; next function
found_writef:
    ; WriteFile index in ecx
    mov [ebp-1Ch], ecx ; store WriteFile index
    mov ecx, [ebp-0Ch] ; pointer to ords
    mov esi, [ebp-20h] ; GetStdHandle index
    mov si, [ecx+esi*2] ; GetStdHandle ord
    mov ecx, [ebp-08h] ; pointer to RVAs
    mov esi, [ecx+esi*4] ; GetStdHandle RVA
    mov eax, [ebp-04h] ; base address
    add esi, eax ; GetStdHandle pointer
    xor ecx, ecx
    xor eax, eax
    mov al, 0Bh
    sub ecx, eax ; stdout is -11
    push ecx ; GetStdHandle arg0
    call esi ; call GetStdHandle
    ; stdout in eax
    push eax ; arg0 WriteFile
    jmp j_get_message
get_message:
    ; get_rip addr on stack
    pop esi
    xor eax, eax
    mov eax, 41414141h + offset get_message_ret - offset msglen
    sub eax, 41414141h 
    sub esi, eax ; pointer to msglen
    xor ecx, ecx
    mov cl, [esi] ; ecx holds msglen
    sub esi, ecx ; esi holds pointer to message
    pop eax ; arg0 WriteFile
    xor edx, edx
    push edx ; arg4 WriteFile
    push edx ; arg3 WriteFile
    push ecx ; arg2 WriteFile
    push esi ; arg1 WriteFile
    push eax ; arg0 WriteFile
    jmp get_message_ret
j_get_message:
    call get_message
get_message_ret:
    mov ecx, [ebp-0Ch] ; pointer to ords
    mov esi, [ebp-1Ch] ; WriteFile index
    xor edi, edi
    mov di, [ecx+esi*2] ; WriteFile ord
    mov ecx, [ebp-08h] ; pointer to RVAs
    mov esi, [ecx+edi*4] ; WriteFile RVA
    mov eax, [ebp-04h] ; base address
    add esi, eax ; WriteFile pointer
    call esi
    epilogue
    ret
db 0DEh, 0ADh, 0BEh, 0EFh
end
        </pre>
    </body>
</html>

