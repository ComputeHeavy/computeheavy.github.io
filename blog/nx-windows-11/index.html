<html>
    <head>
        <style>
            body {
                background-color: #333;
                color: #eee;
                font-family: monospace;
                font-size: 18px;
                width: 900px;
            }

            pre {
                background-color: #444;
                font-size: 16px;
                width: 600px;
            }

            span {
                background-color: #444;
                font-size: 16px;
            }

            a:link {
                color: white;
            }

            a:visited {
                color: hotpink;
            }

            a:hover {
                color: white;
            }

            a:active {
                color: hotpink;
            }
        </style>
    </head>

    <body>
        <h1>Executable Stack or Heap on Windows 11</h1>
        <p>Putting this out there to see if anyone has any ideas. I don't think there is any way to get an executable stack or heap (without VirtualProtect) in a program you compile on Windows 11.</p>

        <p>If you want to follow along you'll need Visual Studio or the Visual Studio Build Tools installed for the the developer command prompt.</p>

        <div>
            <h2>Background</h2>
            <p>Porting the <a href="https://pwn.college">pwn.college</a> (not affiliated) shellcode exercises to Windows right now. These challenges take some shellcode, place it in a stack variable, and run it. I initially thought the linker option <span>/NXCOMPAT:NO</span> would give an executable stack. When it did not I hit it with the old <span>VirtualProtect</span>, made it <span>EXECUTE_READWRITE</span>, and moved on with my life.</p>

            <p>Eventually I got curious how I could get an executable stack and dove a little deeper. That also led to questions about an executable heap. After some investigation, my current assertion is that <b>it is not possible to get an executable stack or heap on Windows 11</b>.
        </div>

        <div>
            <h2>Environment</h2>

            <p>Some of the documentation talked about the system DEP policy, so let's check that first. Open a Command Prompt as Administrator and check with bcdedit.</p>

            <pre>
C:\Windows\System32>bcdedit

Windows Boot Manager
--------------------
identifier              {bootmgr}
device                  partition=\Device\HarddiskVolume1
path                    \EFI\Microsoft\Boot\bootmgfw.efi
description             Windows Boot Manager
locale                  en-US
inherit                 {globalsettings}
default                 {current}
resumeobject            {9378e909-ec67-49fd-ab7b-46c2525300e3}
displayorder            {current}
toolsdisplayorder       {memdiag}
timeout                 30

Windows Boot Loader
-------------------
identifier              {current}
device                  partition=C:
path                    \Windows\system32\winload.efi
description             Windows 11
locale                  en-US
inherit                 {bootloadersettings}
recoverysequence        {9378e909-ec67-49fd-ab7b-46c2525300e3}
displaymessageoverride  Recovery
recoveryenabled         Yes
isolatedcontext         Yes
allowedinmemorysettings 0x15000075
osdevice                partition=C:
systemroot              \Windows
resumeobject            {9378e909-ec67-49fd-ab7b-46c2525300e3}
<b>nx                      OptIn</b>
bootmenupolicy          Standard
            </pre>

            <p>Note the <span>nx OptIn</span> line. Using <span>bcdedit /set nx OptOut</span> works. Due to Secure Boot through, I cannot set it to <span>AlwaysOff</span>. So once again, Secure Boot ruins all our fun.</p>

            <pre>
C:\Windows\System32>bcdedit /set nx alwaysoff
An error has occurred setting the element data.
The value is protected by Secure Boot policy and cannot be modified or deleted.
            </pre>

            <p>We should still be able to do this with <span>OptIn</span> though, right?</p>
            
            <p>...right?</p>

            <p>Let's not give Windows any excuses. I disabled Secure Boot in BIOS, set NX to AlwaysOff, and rebooted.</p>

            <pre>
C:\Windows\System32>bcdedit /set nx alwaysoff
The operation completed successfully.
            </pre>

            <p>In addition, we open the Exploit Protections menu. Since Windows messed around with Control Panel (perfect) and added Settings (awful) on top of it, who knows what this changes, but let's set DEP to off and also put in a program specific override.</p>

            <p><img src="exploit-protections.png"></p>
            
            <p><img src="program-specific-override.png"></p>
        </div>


        <div>
            <h2>The Tools</h2>

            <p>First, we have the API <span>SetProcessDEPPolicy</span>.
        </div>

        <div>
            <h2>Test Program</h2>

            <p>First, I would like to apologize. I cannot afford snytax highlighting at this time.</p>

            <pre>
#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;

void PrintMemoryProtection(DWORD protect) {
    switch (protect) {
        case PAGE_EXECUTE:           printf("Execute\n"); break;
        case PAGE_EXECUTE_READ:      printf("Execute, Read\n"); break;
        case PAGE_EXECUTE_READWRITE: printf("Execute, Read, Write\n"); break;
        case PAGE_EXECUTE_WRITECOPY: printf("Execute, Write Copy\n"); break;
        case PAGE_NOACCESS:          printf("No Access\n"); break;
        case PAGE_READONLY:          printf("Read Only\n"); break;
        case PAGE_READWRITE:         printf("Read, Write\n"); break;
        case PAGE_WRITECOPY:         printf("Write Copy\n"); break;
        case PAGE_GUARD:             printf("Guard Page\n"); break;
        case PAGE_NOCACHE:           printf("No Cache\n"); break;
        case PAGE_WRITECOMBINE:      printf("Write Combine\n"); break;
        default:                     printf("Unknown protection\n"); break;
    }
}

int main() {
    // docs: If the DEP system policy is OptIn or OptOut 
        // and DEP is enabled for the process, setting 
        // dwFlags to 0 disables DEP for the process. 
    // disable dep
    SetProcessDEPPolicy(0);
    
    MEMORY_BASIC_INFORMATION mbi;
    char stack_ptr[0x100];
    char *heap_ptr = (char *)malloc(0x100);

    if (VirtualQuery(stack_ptr, &mbi, sizeof(mbi)) != 0) {
        printf("Memory Protection of %p (stack): ", stack_ptr);
        PrintMemoryProtection(mbi.Protect);
    } else {
        printf("Error getting memory protection\n");
    }

    if (VirtualQuery(heap_ptr, &mbi, sizeof(mbi)) != 0) {
        printf("Memory Protection of %p (heap):  ", heap_ptr);
        PrintMemoryProtection(mbi.Protect);
    } else {
        printf("Error getting memory protection\n");
    }

    free(heap_ptr);

    return 0;
}
        </pre>
    </div>

<!-- // install visual studio
// open developer command prompt
// compile with:
// cl /guard:cf- /Qspectre- /GS- test.c /link /SAFESEH:NO /GUARD:NO /NXCOMPAT:NO /DYNAMICBASE:NO /HIGHENTROPYVA:NO

// confirm no nx with dumpbin
// 8000 DLL characteristics
//     Terminal Server Aware

// versus standard (cl test.c)
// 8160 DLL characteristics
//     High Entropy Virtual Addresses
//     Dynamic base
//     NX compatible
//     Terminal Server Aware

#include <windows.h>
#include <stdio.h>

void PrintMemoryProtection(DWORD protect) {
    switch (protect) {
        case PAGE_EXECUTE:           printf("Execute\n"); break;
        case PAGE_EXECUTE_READ:      printf("Execute, Read\n"); break;
        case PAGE_EXECUTE_READWRITE: printf("Execute, Read, Write\n"); break;
        case PAGE_EXECUTE_WRITECOPY: printf("Execute, Write Copy\n"); break;
        case PAGE_NOACCESS:          printf("No Access\n"); break;
        case PAGE_READONLY:          printf("Read Only\n"); break;
        case PAGE_READWRITE:         printf("Read, Write\n"); break;
        case PAGE_WRITECOPY:         printf("Write Copy\n"); break;
        case PAGE_GUARD:             printf("Guard Page\n"); break;
        case PAGE_NOCACHE:           printf("No Cache\n"); break;
        case PAGE_WRITECOMBINE:      printf("Write Combine\n"); break;
        default:                     printf("Unknown protection\n"); break;
    }
}

int main() {
    // admin command prompt
        // bcdedit
            // nx OptIn

    // docs: If the DEP system policy is OptIn or OptOut 
        // and DEP is enabled for the process, setting 
        // dwFlags to 0 disables DEP for the process. 
    // disable dep
    SetProcessDEPPolicy(0);
    
    MEMORY_BASIC_INFORMATION mbi;
    char stack_ptr[0x100];
    char *heap_ptr = (char *)malloc(0x100);

    if (VirtualQuery(stack_ptr, &mbi, sizeof(mbi)) != 0) {
        printf("Memory Protection of %p (stack): ", stack_ptr);
        PrintMemoryProtection(mbi.Protect);
    } else {
        printf("Error getting memory protection\n");
    }

    if (VirtualQuery(heap_ptr, &mbi, sizeof(mbi)) != 0) {
        printf("Memory Protection of %p (heap):  ", heap_ptr);
        PrintMemoryProtection(mbi.Protect);
    } else {
        printf("Error getting memory protection\n");
    }

    free(heap_ptr);

    return 0;
}

// and yet...
// Memory Protection of 000000000014FDE0 (stack): Read, Write
// Memory Protection of 00000000004743D0 (heap):  Read, Write -->
    </body>
</html>

